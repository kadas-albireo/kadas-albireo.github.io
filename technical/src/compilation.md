Compiling KADAS Albireo
=======================
- - -

* KADAS Albireo is written in C++ using the Qt 5 framework and extended through Python 3 plugins
* Core functionality implemented as Python plugins:
  * Print
  * GPKG Import / Export
  * Help/About
  * OVL importer (requires proprietary MSS component)

### Getting the source code

 * The KADAS Albireo source code is hosted on GitHub at [https://github.com/kadas-albireo/kadas-albireo2](https://github.com/kadas-albireo/kadas-albireo2)
 * A snapshot of the latest codebase can be downloaded from [https://github.com/kadas-albireo/kadas-albireo2/archive/master.zip](https://github.com/kadas-albireo/kadas-albireo2/archive/master.zip)
 * Alternatively the codebase can be cloned using git:

       git clone https://github.com/kadas-albireo/kadas-albireo2.git


### Build requirements

 * The recommended way to build KADAS Albireo for Windows is by using Docker:
   * Docker for Windows requires Windows 10 64bit Pro/Enterprise, build 14393 or later. It can be obtained from [https://docs.docker.com/docker-for-windows/install](https://docs.docker.com/docker-for-windows/install)
   * Docker for Linux can be installed according to [https://docs.docker.com/engine/installation/#server](https://docs.docker.com/engine/installation/#server)
 * KADAS Albireo can also be compiled for any recent Linux distribution

### Building KADAS Albireo for Windows x64 using Docker

 * To compile KADAS Albireo, you need to first download the the latest QGIS Portable build `qgis-portable-win64.zip` from [https://github.com/kadas-albireo/QGIS/releases](https://github.com/kadas-albireo/QGIS/releases). Unpack this inside the `kadas-albireo2` source folder:

       unzip qgis-portable-win64.zip

 * Then, run the followign command to build the docker image:

       docker build -t kadas2-mingw-buildenv .

 * *Note*: The two commands above do not need to be repeated every time, just periodically to make sure the latest versions of QGIS and other build dependencies are used.
 * Next, run the following commands from within the `kadas-albireo2` source folder:

       # Build application
       docker run -v $PWD:/workspace -e QGIS_INSTALL_PREFIX=/workspace/QGIS-Portable kadas2-mingw-buildenv scripts/mingwbuild.sh
       # Install built application and all dependencies into the `kadas` subfolder
       docker run -v $PWD:/workspace kadas2-mingw-buildenv packaging/kadas_release.sh

 * The `kadas` subfolder contains a portable self-contained distribution of KADAS.
   * In the `bin` subfolder, `kadas.exe` will launch KADAS Albireo 2, whereas `qgis.exe` will launch a stock QGIS 3.10.

Deployment
==========
- - -

 * The contents of the build output folder contains all the files necessary for launching a bare instance of KADAS Albireo
 * For a fullly vendored deployment, the following items need to be included:
   * Project templates in `share/kadas/project_templates`, along with any local geodata the project templates may reference
   * Settings templates `settings_full.ini` and `settings_patch.ini` in `share/kadas`
   * Any python plugins, such as the core plugins mentioned above, in `share/kadas/python/plugins`
     * The print plugin is obtainable from [https://github.com/kadas-albireo/kadas-print-plugin](https://github.com/kadas-albireo/kadas-print-plugin)
     * The help/about plugin is obtainable from [https://github.com/kadas-albireo/kadas-help-plugin](https://github.com/kadas-albireo/kadas-help-plugin)
     * The ovl plugin is obtainable from [https://github.com/kadas-albireo/kadas-ovl-plugin](https://github.com/kadas-albireo/kadas-ovl-plugin)
   * These plugins can be added to `share/kadas/python/plugins` inside the build output folder
 * If necessary, CA root certificates in `share/kadas/certificates`
 * To use the MSS/MILX component, the MILX Server component needs to be installed to `opt/mss`
 * The result can be distributed as a portable ZIP, or packaged as an MSI package

Debugging
=========
- - -

 * For low-level debugging, the `gdb` C/C++ debugger is by default bundled with KADAS Albireo
   * `<InstallRoot>\bin\gdb.exe`
 * By default, the binaries contain only minimal debugging information (file and function names only)
 * Full debug symbols (which include source line numbers) are contained in the `*.debug` files, which are generated by the `mingwbuild.sh` build script
   * The official KADAS Albireo release does not install these files by default to save disk space, but they are available in `kadas-portable-debug_<version>.zip`
   * These files need to be placed side-by-side to the respective binaries (i.e. `kadas.exe.debug` in the same folder as `kadas.exe`)
 * Minimal steps for debugging a deployed instance of KADAS Albireo:

       <InstallRoot>\bin\gdb.exe <InstallRoot>\bin\kadas.exe
       run
       # trigger crash
       thread apply all backtrace full
       quit

 * To debug an running instance (i.e. if KADAS Albireo stop responding), the debugger can be attached to a running instance:

       <InstallRoot>\bin\gdb.exe -p <PID of kadas.exe>
       thread apply all backtrace full
       quit

Development
===========
- - -

 * Qt/QGIS development environment (Qt-Creator)
 * C++ Documentation:
   * Qt5: [http://doc.qt.io/qt-5/classes.html](http://doc.qt.io/qt-5/classes.html)
   * QGIS: [http://qgis.org/api/3.10/](http://qgis.org/api/3.10/)
 * PyQGIS:
   * [http://geoapis.sourcepole.com/](http://geoapis.sourcepole.com/)
